package kernel

import (
	"encoding/json"
	"os"
	"testing"
	"time"

	"github.com/MixinNetwork/mixin/common"
	"github.com/MixinNetwork/mixin/crypto"
	"github.com/stretchr/testify/require"
)

func TestGenesis(t *testing.T) {
	require := require.New(t)

	require.Equal("13439.00000000", genesisPledgeAmount().String())

	root, err := os.MkdirTemp("", "mixin-genesis-test")
	require.Nil(err)
	defer os.RemoveAll(root)

	node := setupTestNode(require, root)
	require.NotNil(node)

	now, err := time.Parse(time.RFC3339, "2019-02-28T00:00:00Z")
	require.Nil(err)
	require.Equal(uint64(now.UnixNano()), node.Epoch)

	require.Equal("4d73a8617316f28afd61a74b8c345b3f2cb9033b3da2ab683c86bfefa1a6383b", node.networkId.String())
	nodes := node.NodesListWithoutState(uint64(now.UnixNano())+1, false)
	require.Len(nodes, 15)
	for i, n := range nodes {
		require.Equal(node.Epoch, n.Timestamp)
		require.Equal(common.NodeStateAccepted, n.State)
		require.Equal(genesisNodes[i], n.IdForNetwork.String())
	}

	snapshots, err := node.persistStore.ReadSnapshotsSinceTopology(0, 100)
	require.Nil(err)
	require.Len(snapshots, 16)

	var genesisSnapshots []*SnapshotJSON
	err = json.Unmarshal([]byte(genesisSnapshotsData), &genesisSnapshots)
	require.Nil(err)
	for i, s := range snapshots {
		g := genesisSnapshots[i]
		require.Equal(g.Hash.String(), s.Hash.String())
		require.Equal(g.NodeId.String(), s.NodeId.String())
		require.Nil(g.References)
		require.Nil(s.References)
		require.Equal(g.RoundNumber, s.RoundNumber)
		require.Equal(g.Timestamp, s.Timestamp)
		require.Equal(g.TopologicalOrder, s.TopologicalOrder)
		require.Equal(g.Transactions[0].String(), s.SoleTransaction().String())
		require.Equal(g.Version, s.Version)
	}
}

type SnapshotJSON struct {
	Version      uint8         `json:"version"`
	NodeId       crypto.Hash   `json:"node"`
	Transactions []crypto.Hash `json:"transactions"`
	References   *struct {
		Self     crypto.Hash `json:"self"`
		External crypto.Hash `json:"external"`
	} `json:"references"`
	RoundNumber      uint64      `json:"round"`
	Timestamp        uint64      `json:"timestamp"`
	Hash             crypto.Hash `json:"hash"`
	TopologicalOrder uint64      `json:"topology"`
}

var (
	genesisNodes = []string{
		"0d4bbdc9bff475ded23e14f1e46195bbd31580d9301f90491c6d40ca9a0e318e",
		"2181cf6eb942b0abb4e3d81ebb573e2db573400f6c434e5ef1410d540342c77f",
		"3176875e209ddfd6cfc4bf743746e5ca04c354439010d188b246e01bc39b8153",
		"72ddc2d80b2c45d759aa35d392ceaabcbd1e58341b22e1d2b8c588455d9f5273",
		"78cc5e7430fe43a0516ddc8d425fe1314207b4ff39e2cbb25e89807e06d65954",
		"7de3e4ebdb74df93fdc63a3fefdf7d9852c1997b402a619cff6104f753034f00",
		"8467616ad7a46564a659c9436b1e3ae969efe7bb6c10ce45fa689ab0fe517818",
		"8723373497af49a6833c3caa7aae392efdacc3c3002c1adca66f71e20f9575ae",
		"aea0e6ef1a260f110714e601a46d1cd423be0aa0d57e9159728c2a8997814bf4",
		"b266e7cf8ed627d1926a5e92c2f7617152193362ef3b06eb2a1a54b1db5edbd1",
		"bfabd0265001c740c696dc9def66cc9acf3d5f332cb20efc6b1b62448710c862",
		"d5a951cfb37b3a6670dac2a5d4c517c3093715371f44011b37fbbdf1ddbee0ee",
		"e35422141e9286781231cbb8b0f690eadf117cfddc03c71746c317b90df278d8",
		"f0d33a4768bf9987b45018cc758e098fe681bc73134ce1253d7dbecdd6185cd3",
		"f75ab04c4ddd6391baad5af45f961152177132498cbb244bee5555bc4061df09",
	}
	genesisSnapshotsData = `[{"hash":"7c83d32a6fdbde3e789869ebecf294e51e8d063264227312ab8edfd011c8db05","hex":"777700022181cf6eb942b0abb4e3d81ebb573e2db573400f6c434e5ef1410d540342c77f000000000000000000000001d4943cc2f3acf240ce068965c910788f46d7f1323cf37e496492658a3d7e7ad015875e0b77cd000000000000000000000000000000000000","node":"2181cf6eb942b0abb4e3d81ebb573e2db573400f6c434e5ef1410d540342c77f","references":null,"round":0,"timestamp":1551312000000000000,"topology":0,"transactions":["d4943cc2f3acf240ce068965c910788f46d7f1323cf37e496492658a3d7e7ad0"],"version":2,"witness":{"signature":"3d119f73deed79bbcc4b648a6bb8d5bf419ddf945a4cdac7affa040c81ee0eb672c4783b41a159a8d58ce04694089200e4f146a0e9f7168905219626bb5f490f","timestamp":1696955053661575526}},{"hash":"7d5bced03fb388352fe817f288cc7b76e1b970d4e382e0391fefe6ef14e2f693","hex":"7777000272ddc2d80b2c45d759aa35d392ceaabcbd1e58341b22e1d2b8c588455d9f5273000000000000000000000001c8629d37759c2652e9752b9ee44f9426003509a8c89818c2d2459cf8a295f6dd15875e0b77cd000000000000000000000000000000000001","node":"72ddc2d80b2c45d759aa35d392ceaabcbd1e58341b22e1d2b8c588455d9f5273","references":null,"round":0,"timestamp":1551312000000000000,"topology":1,"transactions":["c8629d37759c2652e9752b9ee44f9426003509a8c89818c2d2459cf8a295f6dd"],"version":2,"witness":{"signature":"beca304c7a44d08cbb02bc8c68824f98c5de66a78875617f19af3554ff2ab0241bb86828abcf14098b8537fe27b74d2ad6784f197b62a6a9773ed554bbffb206","timestamp":1696955053661737919}},{"hash":"7bf45f6cab454981a92a22766ddf4b6a5c848749b79749abc51c46ec2a382295","hex":"777700028467616ad7a46564a659c9436b1e3ae969efe7bb6c10ce45fa689ab0fe5178180000000000000000000000017523942f68e0d04a5a887e53a8632e53fc2ea3a91341af68406785eb8a0bb05e15875e0b77cd000000000000000000000000000000000002","node":"8467616ad7a46564a659c9436b1e3ae969efe7bb6c10ce45fa689ab0fe517818","references":null,"round":0,"timestamp":1551312000000000000,"topology":2,"transactions":["7523942f68e0d04a5a887e53a8632e53fc2ea3a91341af68406785eb8a0bb05e"],"version":2,"witness":{"signature":"46da6bd2ca178a5396fa321d315b3374fd957ce24544682d106fd56a6f4d089dd83ce5c1a4072d44e7c6aae043d227ae3af527546fad84e7817e7a9b126ebe0f","timestamp":1696955053661893586}},{"hash":"2ac55e8b43d0a0d10d81380e7ed65ae3471ef494e5d0f1b6cfca1133ed6d19ae","hex":"777700027de3e4ebdb74df93fdc63a3fefdf7d9852c1997b402a619cff6104f753034f00000000000000000000000001692076963feb2d845a1a600d75cb6865bc4c8d44f683c6e1060c3edc3d5a030315875e0b77cd000000000000000000000000000000000003","node":"7de3e4ebdb74df93fdc63a3fefdf7d9852c1997b402a619cff6104f753034f00","references":null,"round":0,"timestamp":1551312000000000000,"topology":3,"transactions":["692076963feb2d845a1a600d75cb6865bc4c8d44f683c6e1060c3edc3d5a0303"],"version":2,"witness":{"signature":"d070223a022f18e06525597e54de13c9776c9441386fd378e398381adf277be450c893e0389e8761b49b72073b524f215a63ad7ff44f40e7f415e3aa3606060a","timestamp":1696955053662048551}},{"hash":"1b2c840765a2872643f7ed3b8d5859293743f2247ed62e7e74f0684aebaf25dd","hex":"7777000278cc5e7430fe43a0516ddc8d425fe1314207b4ff39e2cbb25e89807e06d65954000000000000000000000001a059fdace5260d77acc79160e605b267043bc3aad566d40efe6f5ecc98efcee215875e0b77cd000000000000000000000000000000000004","node":"78cc5e7430fe43a0516ddc8d425fe1314207b4ff39e2cbb25e89807e06d65954","references":null,"round":0,"timestamp":1551312000000000000,"topology":4,"transactions":["a059fdace5260d77acc79160e605b267043bc3aad566d40efe6f5ecc98efcee2"],"version":2,"witness":{"signature":"ecc78a1099c4d9eeb0bdebbbf54d37c1b6eb47359f1ba8e68067cfee867274f0f609bfc118e04d9c74c56c899b7b2d86cd910f7ec26ccf7ac1bd81f249c7ae09","timestamp":1696955053662202963}},{"hash":"d692a47551ab4d5a47992f0eef9821f509ae91ad9c43c3eb3c991ae738386fe2","hex":"77770002f75ab04c4ddd6391baad5af45f961152177132498cbb244bee5555bc4061df090000000000000000000000015a41c3de860236c99b797e48f3fd2fad1fcc7fcbb2ecaef7d88ed3e454d13ed615875e0b77cd000000000000000000000000000000000005","node":"f75ab04c4ddd6391baad5af45f961152177132498cbb244bee5555bc4061df09","references":null,"round":0,"timestamp":1551312000000000000,"topology":5,"transactions":["5a41c3de860236c99b797e48f3fd2fad1fcc7fcbb2ecaef7d88ed3e454d13ed6"],"version":2,"witness":{"signature":"fef8273672e43e34f55b52b7e3a195b4454df46d11fb7f3218a6436a48b5d20990cf8fa620a779af8e5b72e768e49694b8e30ea3d044af91e6abdd3baefc0802","timestamp":1696955053662280446}},{"hash":"273e7ee1e7b13a70200932ae385785536c8f81ac7f7c3be490309ccc5bdc2371","hex":"777700023176875e209ddfd6cfc4bf743746e5ca04c354439010d188b246e01bc39b81530000000000000000000000019c99a5e288ccac85b774689aa04d675cdb5f8849c230fdef29369b9572eff23815875e0b77cd000000000000000000000000000000000006","node":"3176875e209ddfd6cfc4bf743746e5ca04c354439010d188b246e01bc39b8153","references":null,"round":0,"timestamp":1551312000000000000,"topology":6,"transactions":["9c99a5e288ccac85b774689aa04d675cdb5f8849c230fdef29369b9572eff238"],"version":2,"witness":{"signature":"fbbf69cf99da0e109fa1065560a3de1fb4fd95e9d97a953b03413171f85a45837c2a17bbeda707ef1be8f7c19a96121c611d9f00ce922b46378cd99230acb90e","timestamp":1696955053662349788}},{"hash":"3b01d0e177c123178572fddf6b4cab37df7519cdaf9eaee5bcdeb518d720ce7a","hex":"777700028723373497af49a6833c3caa7aae392efdacc3c3002c1adca66f71e20f9575ae000000000000000000000001ebd0dcff0a13a363084cfe2b9499ebd427ffb3f5f029f074c37659c5a21c9c5315875e0b77cd000000000000000000000000000000000007","node":"8723373497af49a6833c3caa7aae392efdacc3c3002c1adca66f71e20f9575ae","references":null,"round":0,"timestamp":1551312000000000000,"topology":7,"transactions":["ebd0dcff0a13a363084cfe2b9499ebd427ffb3f5f029f074c37659c5a21c9c53"],"version":2,"witness":{"signature":"3f8d40ab6656bf0b20f4512952d7056ca8ca83a7fb7a4a8b750b74be63e8004a72091867d897abba633f2b9166884e102a3b7d77f2f81a37493e207dea9f6a05","timestamp":1696955053662416314}},{"hash":"e3651872106ed9b0785bc5ec1a609600d09651fdc781f5fc45ce6ca9e166fca2","hex":"777700020d4bbdc9bff475ded23e14f1e46195bbd31580d9301f90491c6d40ca9a0e318e00000000000000000000000130beb49f1f4aa7510fba6afcba4aa1b64f7e3d3617223df649bb8eb92a91580915875e0b77cd000000000000000000000000000000000008","node":"0d4bbdc9bff475ded23e14f1e46195bbd31580d9301f90491c6d40ca9a0e318e","references":null,"round":0,"timestamp":1551312000000000000,"topology":8,"transactions":["30beb49f1f4aa7510fba6afcba4aa1b64f7e3d3617223df649bb8eb92a915809"],"version":2,"witness":{"signature":"9b442e45155417d38c9df9aff45e44b117cc9fc8ff25d25f0c66e896ee7d04925124357d48dd8d020ebca86a5a9a02dc14bb0a4fc2e0af14e590cd4c8ef75f00","timestamp":1696955053662483763}},{"hash":"acee39a73260bea08ee0d5ca09c475299498ffa0af5bf0960bf4aa0d0c30b224","hex":"77770002f0d33a4768bf9987b45018cc758e098fe681bc73134ce1253d7dbecdd6185cd30000000000000000000000011600bb652ee1569caa25c2a5bc4ce56a32dc2cf5bc8ce7b9bc1c743316bed7cf15875e0b77cd000000000000000000000000000000000009","node":"f0d33a4768bf9987b45018cc758e098fe681bc73134ce1253d7dbecdd6185cd3","references":null,"round":0,"timestamp":1551312000000000000,"topology":9,"transactions":["1600bb652ee1569caa25c2a5bc4ce56a32dc2cf5bc8ce7b9bc1c743316bed7cf"],"version":2,"witness":{"signature":"499d04e37107e8b59c1ac2de414a153f453b6c97ef3b85c324f9e6149a8c681e41ec74cff63ea25f3907a3c41408e75ffd8a1f349b6a1ff174b0caab01e70a0d","timestamp":1696955053662550315}},{"hash":"c25f6d2df543fe20eeda2d55cf8a5395f9eef4b5e2a45d6614aa2e3202950861","hex":"77770002d5a951cfb37b3a6670dac2a5d4c517c3093715371f44011b37fbbdf1ddbee0ee000000000000000000000001416813d96052565447299fc979656dc1c98e9e8e77d3d9f1a03e287951a58f0a15875e0b77cd00000000000000000000000000000000000a","node":"d5a951cfb37b3a6670dac2a5d4c517c3093715371f44011b37fbbdf1ddbee0ee","references":null,"round":0,"timestamp":1551312000000000000,"topology":10,"transactions":["416813d96052565447299fc979656dc1c98e9e8e77d3d9f1a03e287951a58f0a"],"version":2,"witness":{"signature":"4053081f404a1e8173d089ec1119bd1468b8ea8f665ed31f96713187917aa89f1af27b8a887ef1df22e6c675cfa23d7e751e11f6b9f1c44aff64d6c9f8d44906","timestamp":1696955053662619361}},{"hash":"8b7caf567d77aff480ac886ca2fdb74268b35a281623b3db37ade146f38de37e","hex":"77770002e35422141e9286781231cbb8b0f690eadf117cfddc03c71746c317b90df278d800000000000000000000000115375dfd395517a2c8b63accfa4395f26846e7155f1673a912a05ad20b6373c615875e0b77cd00000000000000000000000000000000000b","node":"e35422141e9286781231cbb8b0f690eadf117cfddc03c71746c317b90df278d8","references":null,"round":0,"timestamp":1551312000000000000,"topology":11,"transactions":["15375dfd395517a2c8b63accfa4395f26846e7155f1673a912a05ad20b6373c6"],"version":2,"witness":{"signature":"edf37a76a1c4b53556b9b65ec61c450ce528fb9a15ccb65c1c23fe1558b54a99700b142c329435defae6a5f091e84284ae79820b158012f30a829338492b7c03","timestamp":1696955053662686975}},{"hash":"ef99df5a87e79bb1da178b19358e7165e7e25a4646c2f9596806b8292edc4998","hex":"77770002bfabd0265001c740c696dc9def66cc9acf3d5f332cb20efc6b1b62448710c8620000000000000000000000018dd6b8788a6927b87103f0529d6f658817d08cade108d0df4522068af1175a5b15875e0b77cd00000000000000000000000000000000000c","node":"bfabd0265001c740c696dc9def66cc9acf3d5f332cb20efc6b1b62448710c862","references":null,"round":0,"timestamp":1551312000000000000,"topology":12,"transactions":["8dd6b8788a6927b87103f0529d6f658817d08cade108d0df4522068af1175a5b"],"version":2,"witness":{"signature":"4d9ab5c6479b6ef31bd2e0480f8b4af24c052a1c1b0e98d1f1a9ed7ba516ea95ce516f6805829275d1f0f5ddc64d8bbc2ce8fab95e98eb43afe64350ab45a10c","timestamp":1696955053662757128}},{"hash":"85636fd394457851ccf503001f8567b680a69b6c70c06c91acc6d8c3767afd3e","hex":"77770002b266e7cf8ed627d1926a5e92c2f7617152193362ef3b06eb2a1a54b1db5edbd1000000000000000000000001d8f551c1dcf69302c1304838ecbe7215cc3c4d5af8386d982712013809cfcfb615875e0b77cd00000000000000000000000000000000000d","node":"b266e7cf8ed627d1926a5e92c2f7617152193362ef3b06eb2a1a54b1db5edbd1","references":null,"round":0,"timestamp":1551312000000000000,"topology":13,"transactions":["d8f551c1dcf69302c1304838ecbe7215cc3c4d5af8386d982712013809cfcfb6"],"version":2,"witness":{"signature":"a51be400d98f1f762a0e61b20c08c5105fb74737d35d088cda9aaea18f48e19ad618e23aa944528590ab19032657a73625af7e7385042b373d866aa909858907","timestamp":1696955053662825069}},{"hash":"c72ccff568aaa07ecebad578f12f665634b70e72f252fdea174286addb472aea","hex":"77770002aea0e6ef1a260f110714e601a46d1cd423be0aa0d57e9159728c2a8997814bf40000000000000000000000015d6409cd38803d67a5a2c4eaef04a90e15f717f8cd230618bd5e7864401ec61f15875e0b77cd00000000000000000000000000000000000e","node":"aea0e6ef1a260f110714e601a46d1cd423be0aa0d57e9159728c2a8997814bf4","references":null,"round":0,"timestamp":1551312000000000000,"topology":14,"transactions":["5d6409cd38803d67a5a2c4eaef04a90e15f717f8cd230618bd5e7864401ec61f"],"version":2,"witness":{"signature":"18c03d4a7c21c8c5844d76edb0dbc7de79bbeedefb2e6fe9d56244461ef2ff5517f75f422c61a307a765b69f1d37720eb185e9a8df85e4c39e741984a0202209","timestamp":1696955053662891504}},{"hash":"b1c077de2b90de5332b863569d1561709bf0359c8ea2da10d73ed797d279e54c","hex":"777700022181cf6eb942b0abb4e3d81ebb573e2db573400f6c434e5ef1410d540342c77f000000000000000000000001b44483e80c974e81a1fd1dacfa0fc39a4ee38bab6c1d9248169b1496269ebd2a15875e0b77cd00010000000000000000000000000000000f","node":"2181cf6eb942b0abb4e3d81ebb573e2db573400f6c434e5ef1410d540342c77f","references":null,"round":0,"timestamp":1551312000000000001,"topology":15,"transactions":["87a3dd5b98b71049a303d2aa823216cebf3198ef0d7e222d77a1764ba965cee2"],"version":2,"witness":{"signature":"adcc2d3296021b27e1dfd692acde70855d06540cdde7e43f97afb1babf3d23c5e49e98ed8fb3ed5a00d2432ae574203aa94eaa756857a8e1cc474677ce97720e","timestamp":1696955053662957637}}]`
)
